<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nany Premia√ß√µes</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #1a1a1a 0%, #2d1b69 50%, #000000 100%); color: #fff; min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .container { width: 100%; max-width: 400px; background: rgba(0,0,0,0.8); border: 2px solid #8B5CF6; border-radius: 15px; padding: 40px; box-shadow: 0 10px 30px rgba(139,92,246,0.3); position: relative; }
        h1, h2, h3 { text-align: center; margin-bottom: 20px; color: #8B5CF6; }
        input, select, button, textarea { padding: 12px; margin-bottom: 15px; border: 1px solid #8B5CF6; border-radius: 8px; background: rgba(255,255,255,0.1); color: #fff; width: 100%; }
        button { background: linear-gradient(135deg, #8B5CF6, #A78BFA); cursor: pointer; font-weight: bold; }
        button:hover { transform: scale(1.05); }
        .panel { display: none; }
        .rifa-item { border: 1px solid #8B5CF6; padding: 10px; margin: 10px 0; border-radius: 8px; }
        .rifa-details { display: none; margin-top: 10px; }
        .rifa-details.active { display: block; }
        .hidden-opt { display: none; }
        .hidden-opt.active { display: block; }
        .error { color: #EF4444; text-align: center; }
        .success { color: #10B981; text-align: center; }
        .notification-btn { position: absolute; top: 10px; right: 10px; width: 40px; height: 40px; border-radius: 50%; background: #8B5CF6; border: none; cursor: pointer; font-size: 20px; }
        .notification-panel { display: none; position: absolute; top: 60px; right: 10px; width: 300px; max-height: 400px; overflow-y: auto; background: rgba(0,0,0,0.9); border: 2px solid #8B5CF6; border-radius: 10px; padding: 15px; z-index: 1000; }
        .notification-panel.active { display: block; }
        .force-update { background: #10B981; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container" id="mainContainer">
        <!-- Auth -->
        <div id="authSection">
            <h1>Nany Premia√ß√µes</h1>
            <form id="authForm">
                <select id="authType">
                    <option value="register">Registrar</option>
                    <option value="login">Login</option>
                </select>
                <input type="text" id="username" placeholder="Usu√°rio" required>
                <input type="password" id="password" placeholder="Senha" required>
                <button type="submit">Entrar</button>
            </form>
            <div id="message"></div>
        </div>

        <!-- User Panel -->
        <div id="userPanel" class="panel">
            <h2>Painel Usu√°rio</h2>
            <p><span id="userName"></span> | Moedas: <span id="userCoins">0</span></p>
            <button class="notification-btn" onclick="toggleNotifications()">üîî</button>
            <div id="notificationPanel" class="notification-panel"></div>
            <button class="force-update" onclick="forceUpdate()">For√ßar Atualiza√ß√£o</button>
            <h3>Participar Rifa</h3>
            <select id="rifaSelect" onchange="showRifaDetails()"></select>
            <div id="rifaDetails" class="rifa-details"></div>
            <h3>Suas Rifas</h3>
            <div id="userRifas"></div>
            <button onclick="logout()">Sair</button>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="panel">
            <h2>Painel Admin</h2>
            <button class="notification-btn" onclick="toggleNotifications()">üîî</button>
            <div id="notificationPanelAdmin" class="notification-panel"></div>
            <button class="force-update" onclick="forceUpdate()">For√ßar Atualiza√ß√£o</button>

            <h3>Enviar Notifica√ß√£o</h3>
            <form id="sendNotificationForm">
                <select id="notifyUserSelect"></select>
                <textarea id="notificationMessage" placeholder="Mensagem" required></textarea>
                <button type="submit">Enviar</button>
            </form>

            <h3>Dar Moedas</h3>
            <form id="giveCoinsForm">
                <select id="userSelect"></select>
                <input type="number" id="coinAmount" placeholder="R$" min="1" required>
                <button type="submit">Dar</button>
            </form>

            <h3>Criar Rifa</h3>
            <form id="createRifaForm">
                <input type="text" id="rifaTitle" placeholder="T√≠tulo" required>
                <input type="date" id="rifaDate" required>
                <input type="number" id="rifaPrice" placeholder="Pre√ßo" min="0.01" step="0.01" required>
                <input type="number" id="totalNumbers" placeholder="N√∫meros" min="1" required>
                <button type="button" onclick="toggleHiddenOpt()">Op√ß√µes Avan√ßadas</button>
                <div id="hiddenOpt" class="hidden-opt">
                    <textarea id="chancesText" placeholder="user1:5:2,user2:3:1"></textarea>
                </div>
                <button type="submit">Criar</button>
            </form>

            <h3>Rifas</h3>
            <div id="adminRifas"></div>
            <button onclick="logout()">Sair</button>
        </div>
    </div>

    <div class="contact">Contato: +55 75 98868-8483</div>

    <script>
        // === CONFIGURA√á√ÉO (SUBSTITUA AQUI) ===
        const GITHUB_TOKEN = 'SEU_NOVO_TOKEN_AQUI'; // <--- COLOQUE O NOVO TOKEN AQUI
        const GITHUB_OWNER = 'SEU_USUARIO';
        const GITHUB_REPO = 'nany-premiacoes';
        const DATA_PATH = 'data.json';
        const DATA_URL = `https://${GITHUB_OWNER}.github.io/${GITHUB_REPO}/${DATA_PATH}`;

        let users = {}, rifas = [], notifications = {}, currentUser = null;

        // Verifica token
        if (GITHUB_TOKEN === 'SEU_NOVO_TOKEN_AQUI') {
            alert('ERRO: Substitua o GITHUB_TOKEN no c√≥digo!');
            throw new Error('Token n√£o configurado');
        }

        async function loadData() {
            try {
                const res = await fetch(DATA_URL + '?t=' + Date.now());
                if (!res.ok) throw new Error('data.json n√£o encontrado');
                const data = await res.json();
                users = data.users || {};
                rifas = data.rifas || [];
                notifications = data.notifications || {};
                console.log('Dados carregados:', { users: Object.keys(users), rifas: rifas.length });

                // Garante admin
                if (!users['admin']) {
                    users['admin'] = { password: 'admin', coins: 0, rifasParticipadas: [] };
                    await saveData();
                    console.log('Admin criado automaticamente');
                }
            } catch (e) {
                console.error('Erro ao carregar:', e);
                showMessage('Erro ao carregar dados. Verifique console.', 'error');
            }
        }

        async function saveData() {
            try {
                const shaRes = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${DATA_PATH}`, {
                    headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
                });
                const shaData = await shaRes.json();
                const sha = shaData.sha;

                const content = btoa(JSON.stringify({ users, rifas, notifications }, null, 2));
                await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${DATA_PATH}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: 'update', content, sha })
                });
                console.log('Dados salvos');
            } catch (e) {
                console.error('Erro ao salvar:', e);
                showMessage('Erro ao salvar! Token inv√°lido?', 'error');
            }
        }

        function forceUpdate() {
            loadData().then(() => {
                if (currentUser) {
                    isAdmin(currentUser) ? loadAdmin() : loadUserData();
                    loadNotifications();
                }
                showMessage('Atualizado!', 'success');
            });
        }

        setInterval(forceUpdate, 15000); // Atualiza a cada 15s

        // === AUTH ===
        document.getElementById('authForm').onsubmit = async (e) => {
            e.preventDefault();
            await loadData();
            const type = document.getElementById('authType').value;
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;

            if (type === 'register') {
                if (users[u]) return showMessage('Usu√°rio existe!', 'error');
                users[u] = { password: p, coins: 0, rifasParticipadas: [] };
                await saveData();
                showMessage('Registrado!', 'success');
            } else {
                if (!users[u] || users[u].password !== p) return showMessage('Senha errada!', 'error');
            }
            login(u);
        };

        function login(u) {
            currentUser = u;
            document.getElementById('userName').textContent = u;
            document.getElementById('userCoins').textContent = users[u].coins;
            hideAuth();
            isAdmin(u) ? (showAdminPanel(), loadAdmin()) : (showUserPanel(), loadUserData());
            loadNotifications();
        }

        function isAdmin(u) { return u === 'admin'; }
        function hideAuth() { document.getElementById('authSection').style.display = 'none'; }
        function showUserPanel() { document.getElementById('userPanel').style.display = 'block'; }
        function showAdminPanel() { document.getElementById('adminPanel').style.display = 'block'; }
        function logout() { location.reload(); }

        // === NOTIFICA√á√ïES ===
        function toggleNotifications() {
            const panel = isAdmin(currentUser) ? 'notificationPanelAdmin' : 'notificationPanel';
            document.getElementById(panel).classList.toggle('active');
            loadNotifications();
        }
        function loadNotifications() {
            const panel = isAdmin(currentUser) ? document.getElementById('notificationPanelAdmin') : document.getElementById('notificationPanel');
            panel.innerHTML = '<h3>Notifica√ß√µes</h3>';
            (notifications[currentUser] || []).forEach(n => panel.innerHTML += `<div class="notification">${n}</div>`);
        }

        // === USU√ÅRIO ===
        function loadRifaSelect() {
            const s = document.getElementById('rifaSelect');
            s.innerHTML = '<option value="">Selecione</option>';
            rifas.forEach(r => {
                if (new Date(r.date) > new Date() && !users[currentUser].rifasParticipadas.some(p => p.rifaId === r.id)) {
                    const o = document.createElement('option');
                    o.value = r.id; o.textContent = `${r.title} - R$${r.price}`;
                    s.appendChild(o);
                }
            });
        }
        function showRifaDetails() {
            const id = document.getElementById('rifaSelect').value;
            const d = document.getElementById('rifaDetails');
            d.innerHTML = ''; d.classList.remove('active');
            if (!id) return;
            const r = rifas.find(x => x.id == id);
            const taken = r.participants.map(p => p.number);
            const avail = Array.from({length: r.totalNumbers}, (_,i) => i+1).filter(n => !taken.includes(n));
            d.innerHTML = `<p>Dispon√≠veis: ${avail.length}</p><select id="num_${id}"><option value="">N√∫mero</option>${avail.map(n=>`<option value="${n}">${n}</option>`).join('')}</select><button onclick="participateRifa(${id})">Entrar</button>`;
            d.classList.add('active');
        }
        async function participateRifa(id) {
            await loadData();
            const r = rifas.find(x => x.id == id);
            const num = +document.getElementById(`num_${id}`).value;
            if (!num || r.participants.some(p => p.number === num)) return showMessage('N√∫mero inv√°lido!', 'error');
            if (users[currentUser].coins < r.price) return showMessage('Sem moedas!', 'error');
            users[currentUser].coins -= r.price;
            users[currentUser].rifasParticipadas.push({ rifaId: id, number: num });
            r.participants.push({ user: currentUser, number: num, chance: 1 });
            await saveData();
            document.getElementById('userCoins').textContent = users[currentUser].coins;
            loadUserRifas(); loadRifaSelect();
        }
        function loadUserRifas() {
            const div = document.getElementById('userRifas');
            div.innerHTML = '';
            users[currentUser].rifasParticipadas.forEach(p => {
                const r = rifas.find(x => x.id === p.rifaId);
                if (r) div.innerHTML += `<p>${r.title} - N¬∫ ${p.number}</p>`;
            });
        }
        async function loadUserData() {
            await loadData();
            loadRifaSelect(); loadUserRifas();
            document.getElementById('userCoins').textContent = users[currentUser].coins;
        }

        // === ADMIN ===
        async function loadAdmin() {
            await loadData();
            ['userSelect', 'notifyUserSelect'].forEach(id => {
                const s = document.getElementById(id);
                s.innerHTML = '';
                Object.keys(users).filter(u => u !== 'admin').forEach(u => {
                    const o = document.createElement('option');
                    o.value = u; o.textContent = `${u} (${users[u].coins})`;
                    s.appendChild(o);
                });
            });

            const div = document.getElementById('adminRifas');
            div.innerHTML = '';
            rifas.forEach(r => {
                const status = new Date(r.date) < new Date() ? (r.winner ? `Ganhador: ${r.winner}` : 'Sorteando...') : 'Ativa';
                div.innerHTML += `<div class="rifa-item">${r.title} - ${status} <button onclick="deleteRifa(${r.id})">Excluir</button></div>`;
            });
        }
        async function deleteRifa(id) {
            rifas = rifas.filter(r => r.id !== id);
            await saveData();
            loadAdmin();
        }
        document.getElementById('sendNotificationForm').onsubmit = async (e) => {
            e.preventDefault();
            const u = document.getElementById('notifyUserSelect').value;
            const m = document.getElementById('notificationMessage').value;
            notifications[u] = notifications[u] || [];
            notifications[u].push(`Admin: ${m}`);
            await saveData();
            e.target.reset();
        };
        document.getElementById('giveCoinsForm').onsubmit = async (e) => {
            e.preventDefault();
            const u = document.getElementById('userSelect').value;
            const a = +document.getElementById('coinAmount').value;
            users[u].coins += a;
            await saveData();
            loadAdmin();
        };
        document.getElementById('createRifaForm').onsubmit = async (e) => {
            e.preventDefault();
            const r = {
                id: Date.now(),
                title: document.getElementById('rifaTitle').value,
                date: document.getElementById('rifaDate').value,
                price: +document.getElementById('rifaPrice').value,
                totalNumbers: +document.getElementById('totalNumbers').value,
                participants: [],
                winner: null,
                chances: {}
            };
            rifas.push(r);
            await saveData();
            e.target.reset();
            loadAdmin();
        };
        function toggleHiddenOpt() { document.getElementById('hiddenOpt').classList.toggle('active'); }

        function showMessage(msg, type) {
            const m = document.getElementById('message');
            m.innerHTML = `<div class="${type}">${msg}</div>`;
            setTimeout(() => m.innerHTML = '', 3000);
        }

        // Inicia
        loadData().then(() => {
            if (localStorage.getItem('autoLogin')) {
                const u = localStorage.getItem('autoLogin');
                if (users[u]) login(u);
            }
        });
        setInterval(() => {
            if (currentUser) forceUpdate();
        }, 15000);
    </script>
</body>
</html>
