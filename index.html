<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nany Premiações</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #1a1a1a 0%, #2d1b69 50%, #000000 100%); color: #fff; min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { width: 100%; max-width: 400px; background: rgba(0,0,0,0.8); border: 2px solid #8B5CF6; border-radius: 15px; padding: 30px; box-shadow: 0 10px 30px rgba(139,92,246,0.3); position: relative; }
        h1, h2, h3 { text-align: center; color: #8B5CF6; margin-bottom: 15px; }
        input, select, button, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #8B5CF6; border-radius: 8px; background: rgba(255,255,255,0.1); color: #fff; }
        button { background: linear-gradient(135deg, #8B5CF6, #A78BFA); cursor: pointer; font-weight: bold; }
        button:hover { transform: scale(1.03); }
        .panel { display: none; }
        .rifa-item { border: 1px solid #8B5CF6; padding: 10px; margin: 10px 0; border-radius: 8px; }
        .hidden-opt { display: none; }
        .hidden-opt.active { display: block; }
        .error { color: #EF4444; text-align: center; }
        .success { color: #10B981; text-align: center; }
        .export-btn { background: #10B981; margin-top: 10px; }
        .force-update { background: #F59E0B; margin-top: 10px; }
        .contact { margin-top: 20px; font-size: 14px; color: #A78BFA; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Auth -->
        <div id="authSection">
            <h1>Nany Premiações</h1>
            <form id="authForm">
                <select id="authType"><option value="login">Login</option><option value="register">Registrar</option></select>
                <input type="text" id="username" placeholder="Usuário" required>
                <input type="password" id="password" placeholder="Senha" required>
                <button type="submit">Entrar</button>
            </form>
            <div id="message"></div>
        </div>

        <!-- User Panel -->
        <div id="userPanel" class="panel">
            <h2>Usuário: <span id="userName"></span></h2>
            <p>Moedas: <span id="userCoins">0</span></p>
            <button class="force-update" onclick="forceUpdate()">Atualizar Agora</button>
            <h3>Participar</h3>
            <select id="rifaSelect" onchange="showRifaDetails()"></select>
            <div id="rifaDetails"></div>
            <h3>Suas Rifas</h3>
            <div id="userRifas"></div>
            <button onclick="logout()">Sair</button>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="panel">
            <h2>Admin</h2>
            <button class="force-update" onclick="forceUpdate()">Atualizar</button>
            <button class="export-btn" onclick="exportData()">Exportar data.json</button>
            <h3>Enviar Notificação</h3>
            <form id="sendNotificationForm">
                <select id="notifyUserSelect"></select>
                <textarea id="notificationMessage" placeholder="Mensagem"></textarea>
                <button type="submit">Enviar</button>
            </form>
            <h3>Dar Moedas</h3>
            <form id="giveCoinsForm">
                <select id="userSelect"></select>
                <input type="number" id="coinAmount" placeholder="R$" min="1">
                <button type="submit">Dar</button>
            </form>
            <h3>Criar Rifa</h3>
            <form id="createRifaForm">
                <input type="text" id="rifaTitle" placeholder="Título">
                <input type="date" id="rifaDate">
                <input type="number" id="rifaPrice" placeholder="Preço" step="0.01">
                <input type="number" id="totalNumbers" placeholder="Números">
                <button type="button" onclick="toggleHiddenOpt()">Opções</button>
                <div id="hiddenOpt" class="hidden-opt">
                    <textarea id="chancesText" placeholder="user1:5:2"></textarea>
                </div>
                <button type="submit">Criar</button>
            </form>
            <h3>Rifas</h3>
            <div id="adminRifas"></div>
            <button onclick="logout()">Sair</button>
        </div>
    </div>
    <div class="contact">PIX: +55 75 98868-8483</div>

    <script>
        // CONFIGURAÇÃO (SÓ ISSO!)
        const REPO_OWNER = 'SEU_USUARIO';  // <--- TROQUE AQUI
        const REPO_NAME = 'nany-premiacoes'; // <--- TROQUE SE FOR DIFERENTE
        const DATA_URL = `https://${REPO_OWNER}.github.io/${REPO_NAME}/data.json?t=${Date.now()}`;

        let data = { users: {}, rifas: [], notifications: {} };
        let currentUser = null;

        // Carrega dados do data.json
        async function loadData() {
            try {
                const res = await fetch(DATA_URL);
                if (!res.ok) throw new Error('data.json não encontrado');
                const json = await res.json();
                data = json;
                if (!data.users['admin']) {
                    data.users['admin'] = { password: 'admin', coins: 100, rifasParticipadas: [] };
                }
                console.log('Dados carregados:', Object.keys(data.users));
            } catch (e) {
                console.error('Erro:', e);
                showMessage('Erro ao carregar data.json', 'error');
            }
        }

        // Exporta JSON para o admin colar no GitHub
        function exportData() {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'data.json';
            a.click();
            showMessage('Baixe e cole no GitHub!', 'success');
        }

        // Salva localmente (só pra exportar depois)
        function saveLocal() {
            // Não salva no GitHub, só na memória
        }

        // Atualiza a cada 15s
        setInterval(() => {
            if (currentUser) loadData().then(updateUI);
        }, 15000);

        function forceUpdate() {
            loadData().then(updateUI);
            showMessage('Atualizado!', 'success');
        }

        function updateUI() {
            if (!currentUser) return;
            if (isAdmin(currentUser)) loadAdmin();
            else loadUserData();
        }

        function showMessage(m, t) {
            const msg = document.getElementById('message') || document.createElement('div');
            msg.innerHTML = `<div class="${t}">${m}</div>`;
            setTimeout(() => msg.innerHTML = '', 3000);
        }

        // Auth
        document.getElementById('authForm').onsubmit = (e) => {
            e.preventDefault();
            const type = document.getElementById('authType').value;
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;

            if (type === 'register') {
                if (data.users[u]) return showMessage('Usuário existe!', 'error');
                data.users[u] = { password: p, coins: 0, rifasParticipadas: [] };
                showMessage('Registrado! Admin: Exporte o JSON!', 'success');
            } else {
                if (!data.users[u] || data.users[u].password !== p) return showMessage('Senha errada!', 'error');
            }
            login(u);
        };

        function login(u) {
            currentUser = u;
            document.getElementById('userName').textContent = u;
            document.getElementById('authSection').style.display = 'none';
            (isAdmin(u) ? document.getElementById('adminPanel') : document.getElementById('userPanel')).style.display = 'block';
            updateUI();
        }

        function isAdmin(u) { return u === 'admin'; }
        function logout() { location.reload(); }

        // User
        function loadUserData() {
            document.getElementById('userCoins').textContent = data.users[currentUser].coins;
            const s = document.getElementById('rifaSelect');
            s.innerHTML = '<option>Selecione</option>';
            data.rifas.forEach(r => {
                if (new Date(r.date) > new Date() && !data.users[currentUser].rifasParticipadas.some(p => p.rifaId === r.id)) {
                    const o = document.createElement('option');
                    o.value = r.id; o.textContent = `${r.title} - R$${r.price}`;
                    s.appendChild(o);
                }
            });
            const div = document.getElementById('userRifas');
            div.innerHTML = '';
            data.users[currentUser].rifasParticipadas.forEach(p => {
                const r = data.rifas.find(x => x.id === p.rifaId);
                if (r) div.innerHTML += `<p>${r.title} - Nº ${p.number}</p>`;
            });
        }

        function showRifaDetails() {
            const id = document.getElementById('rifaSelect').value;
            const d = document.getElementById('rifaDetails');
            d.innerHTML = '';
            if (!id) return;
            const r = data.rifas.find(x => x.id == id);
            const taken = r.participants.map(p => p.number);
            const avail = Array.from({length: r.totalNumbers}, (_,i) => i+1).filter(n => !taken.includes(n));
            d.innerHTML = `<select id="num_${id}">${avail.map(n=>`<option>${n}</option>`).join('')}</select><button onclick="joinRifa(${id})">Entrar</button>`;
        }

        function joinRifa(id) {
            const r = data.rifas.find(x => x.id == id);
            const num = +document.getElementById(`num_${id}`).value;
            if (data.users[currentUser].coins < r.price) return showMessage('Sem moedas!', 'error');
            data.users[currentUser].coins -= r.price;
            data.users[currentUser].rifasParticipadas.push({ rifaId: id, number: num });
            r.participants.push({ user: currentUser, number: num });
            showMessage('Entrou!', 'success');
            loadUserData();
        }

        // Admin
        function loadAdmin() {
            ['userSelect', 'notifyUserSelect'].forEach(id => {
                const s = document.getElementById(id);
                s.innerHTML = '';
                Object.keys(data.users).filter(u => u !== 'admin').forEach(u => {
                    const o = document.createElement('option');
                    o.value = u; o.textContent = u;
                    s.appendChild(o);
                });
            });
            const div = document.getElementById('adminRifas');
            div.innerHTML = '';
            data.rifas.forEach(r => {
                div.innerHTML += `<div class="rifa-item">${r.title} <button onclick="deleteRifa(${r.id})">X</button></div>`;
            });
        }

        document.getElementById('createRifaForm').onsubmit = (e) => {
            e.preventDefault();
            const r = {
                id: Date.now(),
                title: document.getElementById('rifaTitle').value,
                date: document.getElementById('rifaDate').value,
                price: +document.getElementById('rifaPrice').value,
                totalNumbers: +document.getElementById('totalNumbers').value,
                participants: [],
                winner: null
            };
            data.rifas.push(r);
            showMessage('Rifa criada! Exporte o JSON!', 'success');
            loadAdmin();
        };

        function deleteRifa(id) {
            data.rifas = data.rifas.filter(r => r.id !== id);
            loadAdmin();
        }

        document.getElementById('giveCoinsForm').onsubmit = (e) => {
            e.preventDefault();
            const u = document.getElementById('userSelect').value;
            const a = +document.getElementById('coinAmount').value;
            data.users[u].coins += a;
            showMessage('Moedas dadas!', 'success');
        };

        document.getElementById('sendNotificationForm').onsubmit = (e) => {
            e.preventDefault();
            const u = document.getElementById('notifyUserSelect').value;
            const m = document.getElementById('notificationMessage').value;
            data.notifications[u] = data.notifications[u] || [];
            data.notifications[u].push(`Admin: ${m}`);
            showMessage('Enviado!', 'success');
        };

        function toggleHiddenOpt() {
            document.getElementById('hiddenOpt').classList.toggle('active');
        }

        // Inicia
        loadData().then(() => {
            if (localStorage.getItem('lastUser')) {
                const u = localStorage.getItem('lastUser');
                if (data.users[u]) login(u);
            }
        });
    </script>
</body>
</html>
