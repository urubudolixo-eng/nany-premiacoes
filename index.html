<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nany Premia√ß√µes</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #1a1a1a 0%, #2d1b69 50%, #000000 100%); color: #fff; min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { width: 100%; max-width: 400px; background: rgba(0,0,0,0.8); border: 2px solid #8B5CF6; border-radius: 15px; padding: 30px; box-shadow: 0 10px 30px rgba(139,92,246,0.3); position: relative; }
        h1, h2, h3 { text-align: center; color: #8B5CF6; margin-bottom: 15px; }
        input, select, button, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #8B5CF6; border-radius: 8px; background: rgba(255,255,255,0.1); color: #fff; }
        button { background: linear-gradient(135deg, #8B5CF6, #A78BFA); cursor: pointer; font-weight: bold; }
        button:hover { transform: scale(1.03); }
        .panel { display: none; }
        .rifa-item { border: 1px solid #8B5CF6; padding: 10px; margin: 10px 0; border-radius: 8px; }
        .rifa-details { display: none; margin-top: 10px; }
        .rifa-details.active { display: block; }
        .hidden-opt { display: none; }
        .hidden-opt.active { display: block; }
        .error { color: #EF4444; text-align: center; }
        .success { color: #10B981; text-align: center; }
        .notification-btn { position: absolute; top: 10px; right: 10px; width: 40px; height: 40px; border-radius: 50%; background: #8B5CF6; border: none; cursor: pointer; font-size: 20px; }
        .notification-panel { display: none; position: absolute; top: 60px; right: 10px; width: 300px; max-height: 400px; overflow-y: auto; background: rgba(0,0,0,0.9); border: 2px solid #8B5CF6; border-radius: 10px; padding: 15px; z-index: 1000; }
        .notification-panel.active { display: block; }
        .contact { margin-top: 20px; font-size: 14px; color: #A78BFA; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Auth -->
        <div id="authSection">
            <h1>Nany Premia√ß√µes</h1>
            <form id="authForm">
                <select id="authType"><option value="register">Registrar</option><option value="login">Login</option></select>
                <input type="text" id="username" placeholder="Usu√°rio" required>
                <input type="password" id="password" placeholder="Senha" required>
                <button type="submit">Entrar</button>
            </form>
            <div id="message"></div>
        </div>

        <!-- User Panel -->
        <div id="userPanel" class="panel">
            <h2>Usu√°rio: <span id="userName"></span></h2>
            <p>Moedas: <span id="userCoins">0</span></p>
            <button class="notification-btn" onclick="toggleNotifications()">üîî</button>
            <div id="notificationPanel" class="notification-panel"></div>
            <h3>Participar Rifa</h3>
            <select id="rifaSelect" onchange="showRifaDetails()"></select>
            <div id="rifaDetails" class="rifa-details"></div>
            <h3>Suas Rifas</h3>
            <div id="userRifas"></div>
            <button onclick="logout()">Sair</button>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="panel">
            <h2>Admin</h2>
            <button class="notification-btn" onclick="toggleNotifications()">üîî</button>
            <div id="notificationPanelAdmin" class="notification-panel"></div>
            <h3>Enviar Notifica√ß√£o</h3>
            <form id="sendNotificationForm">
                <select id="notifyUserSelect"></select>
                <textarea id="notificationMessage" placeholder="Mensagem"></textarea>
                <button type="submit">Enviar</button>
            </form>
            <h3>Dar Moedas</h3>
            <form id="giveCoinsForm">
                <select id="userSelect"></select>
                <input type="number" id="coinAmount" placeholder="R$" min="1">
                <button type="submit">Dar</button>
            </form>
            <h3>Criar Rifa</h3>
            <form id="createRifaForm">
                <input type="text" id="rifaTitle" placeholder="T√≠tulo">
                <input type="date" id="rifaDate">
                <input type="number" id="rifaPrice" placeholder="Pre√ßo" step="0.01">
                <input type="number" id="totalNumbers" placeholder="N√∫meros">
                <button type="button" onclick="toggleHiddenOpt()">Op√ß√µes Avan√ßadas</button>
                <div id="hiddenOpt" class="hidden-opt">
                    <textarea id="chancesText" placeholder="user1:5:2,user2:3:1"></textarea>
                </div>
                <button type="submit">Criar</button>
            </form>
            <h3>Rifas</h3>
            <div id="adminRifas"></div>
            <button onclick="logout()">Sair</button>
        </div>
    </div>
    <div class="contact">PIX: +55 75 98868-8483</div>

    <script>
        const REPO_OWNER = 'urubudolixo-eng'; // Ex: 'joao123'
        const REPO_NAME = 'nany-premiacoes';
        const DATA_URL = `https://${REPO_OWNER}.github.io/${REPO_NAME}/data.json?t=${Date.now()}`;
        const TOKEN = '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'; // Token novo com escopo 'repo'

        let data = { users: {}, rifas: [], notifications: {} };
        let currentUser = null;
        let currentSha = null;

        // Carrega dados + SHA do GitHub
        async function loadData() {
            try {
                const rawRes = await fetch(`https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${BRANCH}/${FILE_PATH}?t=${Date.now()}`);
                if (!rawRes.ok) throw new Error('Arquivo n√£o encontrado');
                const json = await rawRes.json();
                data = json;

                const apiRes = await fetch(`${API_URL}/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}?ref=${BRANCH}`, {
                    headers: { Authorization: `token ${TOKEN}`, 'Accept': 'application/vnd.github.v3+json' }
                });
                if (!apiRes.ok) throw new Error('Erro API');
                const apiJson = await apiRes.json();
                currentSha = apiJson.sha;

                if (!data.users) data.users = {};
                if (!data.users['admin']) {
                    data.users['admin'] = { password: 'admin', coins: 100, rifasParticipadas: [] };
                    await saveData();
                }
                if (currentUser) updateUI();
            } catch (e) {
                showMessage('Erro ao carregar dados. Verifique token/repo/data.json.', 'error');
                console.error(e);
            }
        }

        // Salva AUTOM√ÅTICO no GitHub (com SHA atualizado)
        async function saveData() {
            try {
                // Atualiza SHA antes de salvar
                const apiRes = await fetch(`${API_URL}/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}?ref=${BRANCH}`, {
                    headers: { Authorization: `token ${TOKEN}`, 'Accept': 'application/vnd.github.v3+json' }
                });
                if (apiRes.ok) {
                    const apiJson = await apiRes.json();
                    currentSha = apiJson.sha;
                }

                const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
                const body = {
                    message: 'Atualiza√ß√£o autom√°tica do sistema',
                    content: content,
                    branch: BRANCH,
                    sha: currentSha
                };

                const putRes = await fetch(`${API_URL}/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
                    method: 'PUT',
                    headers: {
                        Authorization: `token ${TOKEN}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify(body)
                });

                if (!putRes.ok) {
                    const err = await putRes.json();
                    throw new Error(err.message || 'Falha ao salvar');
                }

                // Atualiza SHA ap√≥s salvar
                const putJson = await putRes.json();
                currentSha = putJson.content.sha;
            } catch (e) {
                showMessage('Erro ao salvar no GitHub. Verifique token.', 'error');
                console.error(e);
            }
        }

        // Sincroniza√ß√£o autom√°tica a cada 8s
        setInterval(loadData, 8000);
        loadData();

        function showMessage(msg, type) {
            const div = document.getElementById('message') || document.createElement('div');
            div.id = 'message';
            div.innerHTML = `<div class="${type}">${msg}</div>`;
            if (!document.getElementById('message')) document.body.appendChild(div);
            setTimeout(() => div.innerHTML = '', 5000);
        }

        // Auth - ESPERA CARREGAR E SALVA COM SHA
        document.getElementById('authForm').onsubmit = async (e) => {
            e.preventDefault();
            await loadData(); // Garante dados frescos + SHA
            const type = document.getElementById('authType').value;
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value;

            if (type === 'register') {
                if (data.users[u]) return showMessage('Usu√°rio j√° existe!', 'error');
                data.users[u] = { password: p, coins: 0, rifasParticipadas: [] };
                await saveData();
                showMessage('Registrado com sucesso!', 'success');
            } else {
                if (!data.users[u] || data.users[u].password !== p) return showMessage('Usu√°rio ou senha inv√°lidos!', 'error');
            }
            login(u);
        };

        function login(u) {
            currentUser = u;
            document.getElementById('userName').textContent = u;
            document.getElementById('authSection').style.display = 'none';
            document.getElementById(u === 'admin' ? 'adminPanel' : 'userPanel').style.display = 'block';
            updateUI();
            loadNotifications();
        }

        function logout() { location.reload(); }

        function updateUI() {
            document.getElementById('userCoins').textContent = data.users[currentUser]?.coins || 0;
            if (currentUser === 'admin') loadAdmin();
            else loadUserData();
        }

        // User
        function loadUserData() {
            const s = document.getElementById('rifaSelect');
            s.innerHTML = '<option>Selecione</option>';
            data.rifas.forEach(r => {
                if (new Date(r.date) > new Date() && !data.users[currentUser].rifasParticipadas.some(p => p.rifaId === r.id)) {
                    const o = document.createElement('option');
                    o.value = r.id; o.textContent = `${r.title} - R$${r.price}`;
                    s.appendChild(o);
                }
            });
            const div = document.getElementById('userRifas');
            div.innerHTML = '';
            data.users[currentUser].rifasParticipadas.forEach(p => {
                const r = data.rifas.find(x => x.id === p.rifaId);
                if (r) div.innerHTML += `<p>${r.title} - N¬∫ ${p.number}</p>`;
            });
        }

        function showRifaDetails() {
            const id = document.getElementById('rifaSelect').value;
            const d = document.getElementById('rifaDetails');
            d.innerHTML = '';
            d.classList.remove('active');
            if (!id) return;
            const r = data.rifas.find(x => x.id == id);
            const taken = r.participants?.map(p => p.number) || [];
            const avail = Array.from({length: r.totalNumbers}, (_,i) => i+1).filter(n => !taken.includes(n));
            d.innerHTML = `<select id="num_${id}">${avail.map(n=>`<option value="${n}">${n}</option>`).join('')}</select><button onclick="joinRifa(${id})">Entrar</button>`;
            d.classList.add('active');
        }

        async function joinRifa(id) {
            await loadData();
            const r = data.rifas.find(x => x.id == id);
            const num = +document.getElementById(`num_${id}`).value;
            if (data.users[currentUser].coins < r.price) return showMessage('Sem moedas!', 'error');
            data.users[currentUser].coins -= r.price;
            data.users[currentUser].rifasParticipadas.push({ rifaId: id, number: num });
            r.participants = r.participants || [];
            r.participants.push({ user: currentUser, number: num });
            await saveData();
            showMessage('Entrou na rifa!', 'success');
            updateUI();
        }

        // Admin
        function loadAdmin() {
            ['userSelect', 'notifyUserSelect'].forEach(id => {
                const s = document.getElementById(id);
                s.innerHTML = '';
                Object.keys(data.users).filter(u => u !== 'admin').forEach(u => {
                    const o = document.createElement('option');
                    o.value = u; o.textContent = `${u} (${data.users[u].coins} moedas)`;
                    s.appendChild(o);
                });
            });
            const div = document.getElementById('adminRifas');
            div.innerHTML = '';
            data.rifas.forEach(r => {
                div.innerHTML += `<div class="rifa-item">${r.title} <button onclick="deleteRifa(${r.id})">X</button></div>`;
            });
        }

        async function deleteRifa(id) {
            await loadData();
            data.rifas = data.rifas.filter(r => r.id !== id);
            await saveData();
            showMessage('Rifa exclu√≠da!', 'success');
            loadAdmin();
        }

        document.getElementById('sendNotificationForm').onsubmit = async (e) => {
            e.preventDefault();
            await loadData();
            const u = document.getElementById('notifyUserSelect').value;
            const m = document.getElementById('notificationMessage').value;
            data.notifications[u] = data.notifications[u] || [];
            data.notifications[u].push(`Admin: ${m}`);
            await saveData();
            showMessage('Notifica√ß√£o enviada!', 'success');
            e.target.reset();
        };

        document.getElementById('giveCoinsForm').onsubmit = async (e) => {
            e.preventDefault();
            await loadData();
            const u = document.getElementById('userSelect').value;
            const a = +document.getElementById('coinAmount').value;
            data.users[u].coins += a;
            await saveData();
            showMessage('Moedas dadas!', 'success');
            loadAdmin();
            e.target.reset();
        };

        document.getElementById('createRifaForm').onsubmit = async (e) => {
            e.preventDefault();
            await loadData();
            const r = {
                id: Date.now(),
                title: document.getElementById('rifaTitle').value,
                date: document.getElementById('rifaDate').value,
                price: +document.getElementById('rifaPrice').value,
                totalNumbers: +document.getElementById('totalNumbers').value,
                participants: [],
                winner: null
            };
            data.rifas.push(r);
            await saveData();
            showMessage('Rifa criada!', 'success');
            e.target.reset();
            loadAdmin();
        };

        function toggleHiddenOpt() {
            document.getElementById('hiddenOpt').classList.toggle('active');
        }

        function toggleNotifications() {
            const panel = currentUser === 'admin' ? 'notificationPanelAdmin' : 'notificationPanel';
            document.getElementById(panel).classList.toggle('active');
            loadNotifications();
        }

        function loadNotifications() {
            const panel = currentUser === 'admin' ? document.getElementById('notificationPanelAdmin') : document.getElementById('notificationPanel');
            panel.innerHTML = '<h3>Notifica√ß√µes</h3>';
            (data.notifications[currentUser] || []).forEach(n => panel.innerHTML += `<div>${n}</div>`);
        }
    </script>
</body>
</html>
